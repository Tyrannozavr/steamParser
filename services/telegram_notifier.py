"""
–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Telegram.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –ø—Ä–æ–∫—Å–∏.
"""
import asyncio
from typing import Optional
from loguru import logger

from core.config import Config


async def send_telegram_notification(message: str, chat_id: Optional[str] = None) -> bool:
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram.
    
    Args:
        message: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        chat_id: ID —á–∞—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ Config.TELEGRAM_CHAT_ID)
        
    Returns:
        True –µ—Å–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, False –≤ –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ
    """
    try:
        chat_id = chat_id or Config.TELEGRAM_CHAT_ID
        token = Config.TELEGRAM_BOT_TOKEN
        
        if not token or not chat_id:
            logger.debug("‚ö†Ô∏è TelegramNotifier: –¢–æ–∫–µ–Ω –∏–ª–∏ chat_id –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ")
            return False
        
        # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º aiogram —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
        try:
            from aiogram import Bot
        except ImportError:
            logger.warning("‚ö†Ô∏è TelegramNotifier: aiogram –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ")
            return False
        
        bot = Bot(token=token)
        try:
            await bot.send_message(chat_id=chat_id, text=message, parse_mode="HTML")
            logger.info(f"‚úÖ TelegramNotifier: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram")
            return True
        finally:
            await bot.session.close()
            
    except Exception as e:
        logger.error(f"‚ùå TelegramNotifier: –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram: {e}")
        return False


async def send_proxy_unavailable_notification(blocked_count: int, total_count: int, oldest_proxy_delay: float) -> bool:
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –≤—Å–µ –ø—Ä–æ–∫—Å–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã (–≤—Å–µ 429).
    
    Args:
        blocked_count: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–æ–∫—Å–∏
        total_count: –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–∫—Å–∏
        oldest_proxy_delay: –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å–∞–º–æ–≥–æ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ–∫—Å–∏ (—Å–µ–∫—É–Ω–¥—ã)
        
    Returns:
        True –µ—Å–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
    """
    message = (
        f"üö® <b>–ö–†–ò–¢–ò–ß–ù–û: –í—Å–µ –ø—Ä–æ–∫—Å–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã (429)</b>\n\n"
        f"‚ùå –í—Å–µ –ø—Ä–æ–∫—Å–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –∏–∑-–∑–∞ 429 –æ—à–∏–±–æ–∫:\n"
        f"‚Ä¢ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: <b>{blocked_count}/{total_count}</b>\n"
        f"‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: Too Many Requests –æ—Ç Steam API\n"
        f"‚Ä¢ –û–∂–∏–¥–∞–Ω–∏–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: ~{oldest_proxy_delay/60:.1f} –º–∏–Ω\n\n"
        f"‚ö†Ô∏è –°–∏—Å—Ç–µ–º–∞ –Ω–µ –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ –¥–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–æ–∫—Å–∏.\n"
        f"üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞."
    )
    
    return await send_telegram_notification(message)

