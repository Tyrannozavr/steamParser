# Информация о параллелизме обработки задач

## Текущая конфигурация

### Количество воркеров
- **Запущено воркеров:** 1 контейнер `parsing-worker`
- **Максимум параллельных задач на воркер:** 10 (по умолчанию, настраивается через `MAX_CONCURRENT_TASKS`)
- **RabbitMQ prefetch:** 10 сообщений на воркер

### Итого параллелизм
- **Максимум одновременных задач:** 1 воркер × 10 задач = **10 задач одновременно**

## Настройка параллелизма

### Вариант 1: Увеличить параллелизм в одном воркере

Измените переменную окружения `MAX_CONCURRENT_TASKS` в `.env` или `docker-compose.yml`:

```yaml
environment:
  - MAX_CONCURRENT_TASKS=20  # Увеличить до 20 задач на воркер
```

И обновите `prefetch_count` в `rabbitmq_service.py`:
```python
await self._channel.set_qos(prefetch_count=20)  # Должно совпадать с MAX_CONCURRENT_TASKS
```

**Преимущества:**
- Простое изменение
- Не требует дополнительных ресурсов

**Недостатки:**
- Ограничено ресурсами одного контейнера
- При ошибке воркера все задачи останавливаются

### Вариант 2: Запустить несколько воркеров (горизонтальное масштабирование)

Запустите несколько контейнеров parsing-worker:

```bash
docker compose up -d --scale parsing-worker=3
```

Или добавьте в `docker-compose.yml`:
```yaml
parsing-worker:
  # ... существующая конфигурация ...
  deploy:
    replicas: 3
```

**Преимущества:**
- Высокая отказоустойчивость (если один воркер упадет, другие продолжат работу)
- Масштабируемость (можно добавить больше воркеров)
- Распределение нагрузки

**Недостатки:**
- Больше потребление ресурсов
- Нужно следить за балансировкой

### Вариант 3: Комбинированный подход

- Несколько воркеров (например, 2-3)
- Увеличенный параллелизм в каждом (например, 15-20 задач)

**Итого:** 2 воркера × 15 задач = **30 задач одновременно**

## Рекомендации

### Для текущей нагрузки (небольшое количество задач):
- **1 воркер** с `MAX_CONCURRENT_TASKS=10` достаточно

### Для средней нагрузки:
- **2 воркера** с `MAX_CONCURRENT_TASKS=15` = **30 задач одновременно**

### Для высокой нагрузки:
- **3-5 воркеров** с `MAX_CONCURRENT_TASKS=20` = **60-100 задач одновременно**

## Проверка текущего состояния

```bash
# Количество запущенных воркеров
docker compose ps parsing-worker

# Логи с информацией о параллелизме
docker compose logs parsing-worker | grep "MAX_CONCURRENT_TASKS"

# Количество активных задач в RabbitMQ
# Откройте RabbitMQ Management UI: http://localhost:15672
# Перейдите в Queues -> parsing_tasks -> Consumers
```

## Настройка RabbitMQ prefetch

`prefetch_count` в RabbitMQ должен быть равен или больше `MAX_CONCURRENT_TASKS` для оптимальной работы.

Текущее значение: `prefetch_count=10` (в `rabbitmq_service.py`)
