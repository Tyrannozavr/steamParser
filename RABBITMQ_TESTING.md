# Тестирование RabbitMQ интеграции

## Быстрый старт

### 1. Запуск сервисов

```bash
docker compose up -d
```

Проверьте, что все сервисы запущены:
```bash
docker compose ps
```

### 2. Проверка RabbitMQ Management UI

Откройте в браузере: http://localhost:15672
- Логин: `guest` (или значение из `RABBITMQ_USER`)
- Пароль: `guest` (или значение из `RABBITMQ_PASSWORD`)

В Management UI вы можете:
- Просмотреть очереди (`parsing_tasks`, `parsing_tasks_dlq`)
- Мониторить сообщения
- Проверить retry механизм

### 3. Автотесты

```bash
# Установите зависимости (если еще не установлены)
pip install aio-pika pytest pytest-asyncio

# Запустите тесты
pytest tests/test_rabbitmq_service.py -v
```

### 4. Ручное тестирование

#### Вариант 1: Через скрипт

```bash
python scripts/test_rabbitmq_manual.py
```

Скрипт создаст 3 тестовые задачи и будет отслеживать их выполнение в течение 5 минут.

#### Вариант 2: Через Telegram бота

1. Запустите все сервисы: `docker compose up -d`
2. Откройте Telegram бота
3. Добавьте несколько задач через команды бота
4. Проверьте логи parsing-worker:
   ```bash
   docker compose logs -f parsing-worker
   ```
5. Убедитесь, что:
   - Задачи выполняются без зависаний
   - Задачи повторяются через заданный интервал
   - Несколько задач обрабатываются параллельно

## Проверка стабильности

### Что проверить:

1. **Повторный запуск задач**
   - Задача должна выполняться несколько раз (минимум 3-5 итераций)
   - Интервал между запусками должен соответствовать `check_interval`

2. **Параллельная обработка**
   - Добавьте 3-5 задач одновременно
   - Проверьте, что они обрабатываются параллельно (в логах будут видны одновременные выполнения)

3. **Отсутствие зависаний**
   - Задачи не должны зависать более чем на 10 минут
   - При зависании задача должна автоматически перезапускаться

4. **Retry механизм**
   - При ошибке задача должна повторяться с экспоненциальной задержкой
   - После 5 неудачных попыток задача должна попасть в DLQ

5. **Обработка зависших задач**
   - Если задача выполняется более 10 минут, она должна быть перезапущена

## Мониторинг

### Логи parsing-worker

```bash
docker compose logs -f parsing-worker | grep -E "(Задача|RabbitMQ|обработана|добавлена)"
```

### RabbitMQ Management UI

- **Queues**: Проверьте `parsing_tasks` и `parsing_tasks_dlq`
- **Messages**: Количество сообщений в очередях
- **Consumers**: Количество активных потребителей

### Проверка статистики задач

Через Telegram бота используйте команду для просмотра статистики задач.

## Устранение проблем

### Задачи не выполняются

1. Проверьте, что RabbitMQ запущен:
   ```bash
   docker compose ps rabbitmq
   ```

2. Проверьте логи parsing-worker:
   ```bash
   docker compose logs parsing-worker | grep -i error
   ```

3. Проверьте подключение к RabbitMQ в Management UI

### Задачи зависают

1. Проверьте логи на наличие ошибок
2. Проверьте, что задачи не превышают лимит времени выполнения (10 минут)
3. Проверьте DLQ на наличие failed задач

### Retry не работает

1. Проверьте настройки retry в `rabbitmq_service.py`
2. Проверьте логи на наличие ошибок при обработке retry
3. Проверьте, что retry exchange настроен правильно

## Переменные окружения

Добавьте в `.env` файл (если нужно изменить значения по умолчанию):

```env
RABBITMQ_ENABLED=true
RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
RABBITMQ_USER=guest
RABBITMQ_PASSWORD=guest
```
