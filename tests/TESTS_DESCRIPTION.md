# Описание тестов воспроизведения проблем

## Обзор

Тесты в `test_problems_reproduction.py` демонстрируют наличие проблем, обнаруженных в логах (пупу.txt). 
**Важно**: Эти тесты НЕ исправляют проблемы, а показывают их наличие.

## Принцип работы тестов

Тесты написаны так, что:
1. **Демонстрируют проблему** - показывают, что проблема существует в текущей реализации
2. **Не падают из-за ошибок** - используют корректные моки и проверки
3. **После исправления перестанут демонстрировать проблему** - когда код будет исправлен, тесты должны показывать, что проблема решена

## Детальное описание тестов

### Тест 1: `test_problem_1_massive_429_errors`

**Проблема**: Массовые 429 ошибки приводят к блокировке всех прокси.

**Как демонстрирует**:
- Создает список прокси
- Симулирует 429 ошибки для всех прокси
- Проверяет, что после 429 ошибок прокси все еще доступны (проблема: они должны быть заблокированы)

**После исправления**: Тест должен показывать, что прокси блокируются после 429 ошибок.

---

### Тест 2: `test_problem_2_stuck_parsing_tasks`

**Проблема**: Задачи парсинга зависают и превышают лимит в 10 минут.

**Как демонстрирует**:
- Создает задачу парсинга, которая симулирует долгое выполнение
- Проверяет, что задача возвращает ошибку "Timeout" или выполняется долго

**После исправления**: Тест должен показывать, что задачи завершаются в разумное время.

---

### Тест 3: `test_problem_3_proxy_acquisition_timeout`

**Проблема**: Таймауты при попытке получить прокси (30 секунд).

**Как демонстрирует**:
- Симулирует ситуацию, когда все прокси заняты
- `get_next_proxy()` ждет долго и возвращает None
- Проверяет, что возникает таймаут при попытке получить прокси

**После исправления**: Тест должен показывать, что прокси получаются без таймаутов.

---

### Тест 4: `test_problem_4_concurrent_db_access_errors`

**Проблема**: Ошибки конкурентного доступа к БД.

**Как демонстрирует**:
- Симулирует ошибку "cannot perform operation: another operation is in progress"
- Проверяет, что ошибка возникает при конкурентном доступе

**После исправления**: Тест должен показывать, что ошибки конкурентного доступа не возникают.

---

### Тест 5: `test_problem_5_http_request_timeouts`

**Проблема**: HTTP-запросы таймаутят после 60 секунд.

**Как демонстрирует**:
- Симулирует долгий HTTP-запрос
- Проверяет, что запрос таймаутит

**После исправления**: Тест должен показывать, что запросы не таймаутят.

---

### Тест 6: `test_problem_6_redis_service_get_attribute_error`

**Проблема**: `'RedisService' object has no attribute 'get'`.

**Как демонстрирует**:
- Создает мок RedisService без метода `get()`
- Пытается использовать `redis_service.get()` (как в реальном коде)
- Проверяет, что возникает ошибка AttributeError

**Реальная проблема**: В `parallel_listing_parser.py:88` используется `await redis_service.get(key)`, 
но `RedisService` не имеет метода `get()`, только `_client.get()`.

**После исправления**: Тест должен показывать, что метод `get()` существует или код использует правильный API.

---

### Тест 7: `test_problem_7_cascade_degradation`

**Проблема**: Каскадный эффект всех проблем вместе.

**Как демонстрирует**:
- Симулирует все проблемы одновременно:
  1. Массовые 429 ошибки → все прокси блокируются
  2. Нет доступных прокси → таймауты при получении прокси
  3. Задачи не могут получить прокси → зависают
  4. Конкурентный доступ к БД → ошибки

**После исправления**: Тест должен показывать, что проблемы изолированы и не вызывают каскадный эффект.

---

### Тест 8: `test_problem_8_long_running_heartbeat`

**Проблема**: Воркеры работают очень долго на определенных этапах.

**Как демонстрирует**:
- Симулирует долгую работу воркера на этапах "выполнение_запроса" и "сохранение_результатов"
- Проверяет, что время выполнения превышает ожидаемое

**После исправления**: Тест должен показывать, что воркеры работают в разумное время.

---

## Запуск тестов

### Через pytest (если установлен):
```bash
pytest tests/test_problems_reproduction.py -v
```

### Через скрипт (без pytest):
```bash
python3 tests/run_problems_tests.py
```

### Требования:
- Все зависимости из `requirements.txt` должны быть установлены
- Тесты используют моки, поэтому не требуют реальной БД или Redis

---

## Интерпретация результатов

- **Тест проходит**: Проблема демонстрируется (это ожидаемо до исправления)
- **Тест проваливается**: Либо проблема уже исправлена, либо тест написан неправильно

**Важно**: После исправления кода тесты должны быть обновлены, чтобы проверять, что проблемы решены.

---

## Следующие шаги

1. ✅ Тесты созданы и демонстрируют проблемы
2. ⏳ Исправить код для решения проблем
3. ⏳ Обновить тесты, чтобы они проверяли, что проблемы решены
4. ⏳ Запустить тесты и убедиться, что все проблемы исправлены
