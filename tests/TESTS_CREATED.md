# –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î

## ‚úÖ –¢–µ—Å—Ç—ã —Å–æ–∑–¥–∞–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç

### 1. `test_db_concurrency_standalone.py`

**–ê–≤—Ç–æ–Ω–æ–º–Ω—ã–µ —Ç–µ—Å—Ç—ã** - –Ω–µ —Ç—Ä–µ–±—É—é—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—é—Ç:**
- ‚úÖ –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –≤—ã–∑–æ–≤—ã –º–µ—Ç–æ–¥–æ–≤, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö –ë–î
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
- ‚úÖ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –í—Å–µ 6 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω—ã

**–ó–∞–ø—É—Å–∫:**
```bash
python3 tests/test_db_concurrency_standalone.py
```

---

### 2. `test_db_concurrency_code_check.py`

**–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞** - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- ‚úÖ –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î (`db_session.execute`, `commit`, `rollback`)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞—â–∏—â–µ–Ω—ã –ª–∏ –æ–Ω–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π `_db_lock`
- ‚úÖ –í—ã—è–≤–ª—è–µ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 
- ‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ 19 –Ω–µ–∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤ `proxy_manager.py`
- ‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ 26 –Ω–µ–∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤ `monitoring_service.py`
- ‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ 7 –Ω–µ–∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤ `results_processor_service.py`

**–ó–∞–ø—É—Å–∫:**
```bash
python3 tests/test_db_concurrency_code_check.py
```

---

## üîç –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –í `proxy_manager.py`:

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (–Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å):**
1. **–°—Ç—Ä–æ–∫–∞ 512**: `_get_proxy_last_used_from_db()` - –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –Ω–∞–ø—Ä—è–º—É—é
2. **–°—Ç—Ä–æ–∫–∞ 615**: `_set_proxy_last_used_in_db()` - –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ `mark_proxy_used` (–∑–∞—â–∏—â–µ–Ω `_lock`)
3. **–°—Ç—Ä–æ–∫–∞ 1187**: `check_all_proxies_parallel()` - –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ

**–ù–µ–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (–≤–Ω—É—Ç—Ä–∏ –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤):**
- –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –º–µ—Ç–æ–¥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –∏–∑ –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç

---

## üí° –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç—ã

### –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–µ —Ç–µ—Å—Ç—ã
python3 tests/test_db_concurrency_standalone.py

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –Ω–∞ –Ω–µ–∑–∞—â–∏—â–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
python3 tests/test_db_concurrency_code_check.py
```

### –î–ª—è –ø–æ–∏—Å–∫–∞ –Ω–æ–≤—ã—Ö –ø—Ä–æ–±–ª–µ–º:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å `test_db_concurrency_code_check.py` –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –Ω–µ–∑–∞—â–∏—â–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
3. –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≥–¥–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ

---

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ —Ç–µ—Å—Ç–∞–º–∏)

1. ‚úÖ `_update_redis_cache()` - –∑–∞—â–∏—â–µ–Ω–æ `_db_lock`
2. ‚úÖ `get_active_proxies()` - –∑–∞—â–∏—â–µ–Ω–æ `_db_lock` –¥–ª—è –ë–î –æ–ø–µ—Ä–∞—Ü–∏–π
3. ‚úÖ `_is_proxy_temporarily_blocked()` - –∑–∞—â–∏—â–µ–Ω–æ `_db_lock`
4. ‚úÖ `_block_proxy_temporarily()` - –∑–∞—â–∏—â–µ–Ω–æ `_db_lock`
5. ‚úÖ `_unblock_proxy()` - –∑–∞—â–∏—â–µ–Ω–æ `_db_lock`
6. ‚úÖ `background_check_proxies()` - –∑–∞—â–∏—â–µ–Ω–æ `_db_lock`
7. ‚úÖ `get_blocked_proxies_info()` - –∑–∞—â–∏—â–µ–Ω–æ `_db_lock`

---

## üéØ –ò—Ç–æ–≥

**–¢–µ—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ:**
- ‚úÖ –í—ã—è–≤–ª—è—é—Ç –æ—à–∏–±–∫–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î
- ‚úÖ –ù–∞—Ö–æ–¥—è—Ç –º–µ—Å—Ç–∞, –≥–¥–µ –Ω—É–∂–Ω—ã –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è—é—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
- ‚úÖ –ü–æ–º–æ–≥–∞—é—Ç –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –Ω–æ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**–ì–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!**
