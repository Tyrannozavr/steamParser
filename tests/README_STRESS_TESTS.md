# Стресс-тесты для проверки защиты от блокировок БД

## Описание

Эти тесты проверяют, что исправления предотвращают блокировки БД при одновременном обновлении одной задачи из разных процессов.

## Проблема, которую решаем

**До исправления:**
- `parsing-worker` обновлял задачу через ORM (`task.total_checks += 1`)
- `monitoring-service` обновлял `next_check` через UPDATE
- `process_results` обновлял `items_found` через UPDATE
- При одновременном обновлении возникали блокировки БД

**После исправления:**
- Все обновления используют атомарные UPDATE запросы
- Блокировки предотвращены
- Таймауты уменьшены для быстрого обнаружения проблем

## Тесты

### 1. `test_db_lock_stress.py` - Основной стресс-тест

Симулирует реальные сценарии:
- ParsingWorker обновляет задачу (total_checks, last_check, next_check)
- MonitoringService обновляет next_check
- process_results обновляет items_found и total_checks

**Запуск:**
```bash
python3 tests/test_db_lock_stress.py
```

**Что проверяет:**
- Нет блокировок БД при одновременных обновлениях
- Все операции завершаются успешно
- Время выполнения операций в разумных пределах

### 2. `test_db_lock_comparison.py` - Сравнительный тест

Сравнивает старый способ (ORM) и новый способ (атомарный UPDATE).

**Запуск:**
```bash
python3 tests/test_db_lock_comparison.py
```

**Что проверяет:**
- Новый способ имеет меньше ошибок
- Новый способ быстрее
- Новый способ не вызывает блокировки

## Требования

- Активные задачи в БД (минимум 1 для базового теста, 2+ для расширенного)
- Доступ к БД через `Config.DATABASE_URL`
- Python 3.8+

## Ожидаемые результаты

### Успешный тест:
```
✅ ТЕСТ ПРОЙДЕН: Блокировки не обнаружены, защита работает!
```

### Неудачный тест:
```
❌ ОБНАРУЖЕНЫ БЛОКИРОВКИ БД! Защита не работает.
```

## Интерпретация результатов

- **Блокировки = 0**: ✅ Защита работает
- **Таймауты < 10%**: ✅ Производительность в норме
- **Таймауты > 10%**: ⚠️ Возможны проблемы с производительностью БД
- **Блокировки > 0**: ❌ Защита не работает, нужны дополнительные исправления

## Стресс-сценарии

Тесты симулируют:
1. **Высокая нагрузка**: 10 одновременных операций на одну задачу
2. **Длительная нагрузка**: 100+ итераций
3. **Множественные задачи**: Обновление нескольких задач одновременно
4. **Смешанные операции**: Разные типы обновлений одновременно

## Рекомендации

Если тесты показывают проблемы:
1. Проверьте настройки БД (пул соединений, таймауты)
2. Проверьте индексы на таблице `monitoring_tasks`
3. Проверьте нагрузку на БД от других процессов
4. Увеличьте таймауты, если БД медленная
